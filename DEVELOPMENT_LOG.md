# 视频下载器开发日志

## 项目结构
```
src/
├── core/                     # 核心功能模块
│   ├── downloader.py        # 下载器基类
│   └── exceptions.py        # 异常定义
└── plugins/                  # 插件模块
    └── twitter/             # Twitter下载插件
        ├── downloader.py    # Twitter下载器实现
        └── config.py        # Twitter下载器配置
```

## 功能组件说明

### 1. 核心组件 (src/core/)

#### 1.1 BaseDownloader (downloader.py)
- 功能：定义下载器的基本接口和通用功能
- 特点：
  - 抽象基类设计，确保所有下载器实现统一接口
  - 支持进度回调
  - 支持下载取消
  - 统一的异常处理机制
- 设计原因：
  - 便于扩展新的平台下载器
  - 统一的接口便于上层应用调用
  - 复用通用功能，减少代码重复

#### 1.2 异常类 (exceptions.py)
- 功能：定义项目中使用的所有异常类
- 特点：
  - 层次化的异常体系
  - 针对不同场景的专门异常类
- 设计原因：
  - 便于精确的错误处理
  - 提供清晰的错误信息
  - 支持不同平台的特定错误

### 2. Twitter插件 (src/plugins/twitter/)

#### 2.1 TwitterDownloader (downloader.py)
- 功能：实现Twitter视频和图片的下载
- 特点：
  - 支持视频和图片下载
  - 自动选择最高质量版本
  - 支持代理设置
  - 支持并发下载
  - 支持速度限制
  - 支持进度回调
  - 支持取消操作
  - 使用Playwright进行内容提取
- 设计原因：
  - Twitter内容是动态加载的，需要浏览器环境
  - 需要绕过反爬虫机制
  - 确保下载的稳定性和可靠性

#### 2.2 TwitterDownloaderConfig (config.py)
- 功能：Twitter下载器的配置管理
- 特点：
  - 使用dataclass简化配置
  - 支持配置序列化
  - 提供默认值
  - 支持配置验证
- 设计原因：
  - 便于配置管理和修改
  - 支持配置的保存和加载
  - 提供类型安全的配置访问

## 开发历程

### 1. 尝试过的方案
1. Selenium方法
   - 问题：找不到Chrome浏览器安装路径
   - 原因：环境配置复杂，依赖外部浏览器

2. yt-dlp方法
   - 问题：无法从推文中提取视频URL
   - 原因：Twitter更新了页面结构

3. Twitter API v2
   - 问题：API访问权限不足（403错误）
   - 原因：Twitter API访问限制增加

4. Twitter GraphQL API
   - 问题：API端点不可用（404错误）
   - 原因：Twitter更改了API结构

### 2. 当前方案（Playwright）
- 使用Playwright模拟浏览器访问
- 优点：
  - 可以执行JavaScript
  - 支持等待动态内容加载
  - 可以绕过基本的反爬虫措施
  - 支持代理配置
- 注意事项：
  - 需要下载浏览器环境
  - 资源消耗相对较大
  - 首次运行需要额外设置

## 注意事项

### 1. 组件冲突预防
1. 下载器冲突
   - 不同平台的下载器应该继承BaseDownloader
   - 确保实现所有抽象方法
   - 不要在子类中修改基类的核心行为

2. 配置冲突
   - 每个平台使用独立的配置类
   - 配置参数名称要具有平台特异性
   - 避免使用通用名称造成混淆

3. 异常处理冲突
   - 使用特定平台的异常类
   - 确保异常能够正确向上传播
   - 避免吞掉重要异常

### 2. 未来扩展注意事项
1. 添加新平台时：
   - 创建独立的插件目录
   - 实现平台特定的下载器类
   - 创建平台特定的配置类
   - 添加平台特定的异常类

2. 更新现有平台时：
   - 保持向后兼容
   - 更新相关文档
   - 添加版本迁移说明

3. 添加新功能时：
   - 评估是否应该添加到基类
   - 考虑对现有代码的影响
   - 确保新功能的通用性

## TODO
1. 完善错误处理
   - 添加更多特定错误类型
   - 改进错误信息的可读性

2. 改进配置管理
   - 添加配置文件支持
   - 支持运行时配置修改

3. 优化性能
   - 实现智能重试机制
   - 优化并发下载策略
   - 添加下载队列管理

## 已完成的功能组件

### 1. 配置系统 (`DownloaderConfig`)
- 文件名模板和变量支持
- JSON 格式配置保存/加载
- 完整的类型注解和文档
- 特点：灵活的配置管理，支持多平台

### 2. 速度限制器 (`SpeedLimiter`)
- 基于令牌桶算法
- 支持同步和异步操作
- 实时速度统计
- 特点：精确的流量控制，平滑的下载体验

### 3. GraphQL API 客户端
- 支持查询、变更和订阅
- 代理和自定义请求头
- 完整的类型定义
- 特点：现代化的 API 交互方式

### 4. Twitter 插件套件
#### 4.1 反爬虫模块 (`anti_crawl.py`)
- Cloudflare 5秒盾破解
- 自动保存/复用验证结果
- 代理支持
- 特点：稳定的访问保证

#### 4.2 信息提取器 (`extractor.py`)
- 推文信息解析
- 媒体 URL 提取
- 错误处理
- 特点：准确的内容获取

#### 4.3 下载器 (`downloader.py`)
- 流式下载（内存优化）
- 实时进度和速度显示
- 支持取消操作
- 并发下载控制
- 特点：高效的资源管理

### 5. B站插件套件
#### 5.1 签名模块 (`sign.py`)
- WBI 签名算法
- 自动密钥获取
- 特点：安全的接口访问

### 6. 通用功能
- 异步 IO 优先设计
- 完整的错误处理
- 国际化支持
- 代理服务器支持
- 特点：健壮的基础架构

## 开发规范遵循情况
1. 代码规范
- ✅ Python 3.10+ 语法
- ✅ 类型注解全覆盖
- ✅ PEP8 规范
- ✅ Google 风格文档字符串
- ✅ JSON 格式配置

2. 架构约束
- ✅ MVVM 分层
- ✅ 插件式架构
- ✅ 异步 IO 优先

3. 质量要求
- ✅ 单元测试覆盖
- ✅ 完整错误处理
- ✅ 性能优化

## 待办事项
1. 完善 B 站 WBI 签名功能
2. 实现用户 ID 获取功能
3. 优化并发下载控制
4. 添加更多平台支持

## 最近更新
1. 优化了 Twitter 流式下载功能
   - 改进内存管理
   - 添加实时速度显示
   - 支持下载取消

2. 实现了 Cloudflare 绕过
   - 使用 undetected-chromedriver
   - 添加 cookies 管理
   - 支持自动重试 