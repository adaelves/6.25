# 视频下载器开发日志

## 项目架构

### 目录结构
```
project_root/
├── configs/          # 配置文件目录
│   └── proxies.yaml  # 代理配置
├── logs/            # 日志文件目录
├── src/             # 源代码目录
│   ├── core/        # 核心功能
│   │   ├── downloader.py  # 下载器基类
│   │   └── exceptions.py  # 异常定义
│   ├── plugins/     # 插件目录
│   │   ├── twitter/  # Twitter插件
│   │   ├── youtube/  # YouTube插件
│   │   └── pornhub/  # Pornhub插件
│   ├── services/    # 服务层
│   └── ui/          # 用户界面
└── tests/           # 测试用例
    ├── unit/       # 单元测试
    ├── integration/ # 集成测试
    └── performance/ # 性能测试
```

## 最新更新 (2024-06-27)

### 1. 下载器核心改进
- 将yt-dlp设置为默认下载器
- 统一的下载接口和配置系统
- 改进错误处理和重试机制
- 优化进度回调系统
- 完善日志记录

### 2. 认证系统重构
1. 界面改进
   - 统一认证入口，将"工具 -> Cookie管理"改为"账号"菜单
   - 为每个平台提供独立的登录管理
   - 分离基础功能和高级功能
   - 优化状态显示和用户反馈

2. Cookie管理对话框改进
   - 新增标签页设计，分离基础和高级选项
   - 添加自定义浏览器路径选择功能
   - 支持多平台Cookie同步
   - 优化状态显示
   - 添加同步成功自动关闭功能

### 3. 平台特定更新

#### YouTube下载器
- 修复初始化错误（max_height参数问题）
- 添加配置迁移系统
- 实现向后兼容
- 添加自动配置备份和恢复
- 优化视频质量选择逻辑

#### Pornhub下载器
- 修复m3u8下载问题
- 实现proper base_uri处理
- 添加自定义HTTP头支持
- 改进错误处理和重试机制
- 添加进度跟踪
- 实现yt-dlp降级方案

#### Twitter下载器
- 改进API认证机制
- 优化Cookie更新逻辑
- 添加浏览器模拟下载
- 实现用户视频批量下载
- 改进媒体质量选择

### 4. 数据库系统实现
- 创建完整数据模型（Video, Tag, Category, DownloadHistory）
- 实现DatabaseManager和CRUD操作
- 添加视频元数据存储
- 实现下载历史跟踪
- 添加标签和分类管理

## 已解决的问题

### 1. YouTube相关
- 问题：配置错误 "unexpected keyword argument 'max_height'"
- 原因：配置参数变更
- 解决：添加配置迁移系统，自动转换旧格式

### 2. Pornhub相关
- 问题：m3u8下载失败 "base_uri with no base_uri set"
- 原因：m3u8解析问题
- 解决：手动处理base_uri，添加yt-dlp降级方案

### 3. Twitter相关
- 问题：API访问权限不足（403错误）
- 原因：认证问题
- 解决：实现自定义API签名和认证

### 4. 性能问题
- 问题：大文件下载内存占用过高
- 解决：实现流式下载，控制缓冲区大小
- 问题：并发控制导致请求失败
- 解决：实现下载调度器，控制并发数量

### 5. 代理问题
- 问题：代理连接不稳定
- 解决：实现自动重试和故障转移
- 配置：默认代理地址 "127.0.0.1:7890"

## 开发规范

### 1. 代码规范
- Python 3.10+语法
- 类型注解全覆盖
- PEP8规范
- Google风格文档字符串
- JSON格式配置文件
- logging模块日志记录

### 2. 架构约束
- 严格MVVM分层
- 插件式架构
- 异步IO优先

### 3. 质量要求
- 单元测试覆盖率≥80%
- 网络超时30秒
- 自动重试（指数退避）
- 内存峰值≤500MB
- 大文件流式处理

### 4. 界面规范
- 完整国际化支持
- 无障碍访问
- 外置QSS样式
- 高DPI支持
- 主题切换

## 待优化项目

### 1. 功能增强
- [ ] 添加更多下载源支持
- [ ] 改进下载队列管理
- [ ] 添加下载速度限制
- [ ] 实现断点续传

### 2. 用户体验
- [ ] 优化进度显示
- [ ] 添加更多配置选项
- [ ] 改进错误提示
- [ ] 添加操作指南

### 3. 性能优化
- [ ] 优化内存使用
- [ ] 改进并发控制
- [ ] 添加缓存机制
- [ ] 优化代理选择

### 4. 安全性
- [ ] Cookie加密存储
- [ ] 安全的Cookie传输
- [ ] Cookie有效期检查
- [ ] 请求签名机制

## 注意事项

### 1. 开发提示
- 每次新建组件前先查看现有功能
- 及时更新开发日志
- 遵循代码规范和架构约束
- 注意异常处理和日志记录

### 2. 代理设置
- 默认代理地址：127.0.0.1:7890
- 支持HTTP/SOCKS代理
- 自动重试机制
- 配置文件：configs/proxies.yaml

### 3. 测试要求
- 核心下载器单元测试（必须）
- 界面组件快照测试（必须）
- 性能基准测试（推荐）
- 集成测试覆盖关键路径 